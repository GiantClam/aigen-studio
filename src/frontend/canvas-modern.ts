export function generateModernCanvasPage(): string {
  return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® AI Gen Studio Canvas - ‰∏ì‰∏öÁªòÂõæÂ∑•ÂÖ∑</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: rgba(148, 163, 184, 0.2);
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            height: 100vh;
            overflow: hidden;
            color: var(--text-primary);
        }
        
        .canvas-layout {
            display: flex;
            height: 100vh;
        }
        
        /* ‰∏ªÁîªÂ∏ÉÂå∫Âüü */
        .main-canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        /* Áé∞‰ª£ÂåñÂ∑•ÂÖ∑Ê†è */
        .canvas-toolbar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        .tool-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .tool-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mode-selector {
            display: flex;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border-color);
        }
        
        .mode-btn {
            background: transparent;
            color: rgba(203, 213, 225, 0.8);
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            min-width: 70px;
        }
        
        .mode-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: white;
            transform: translateY(-1px);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .mode-btn i {
            font-size: 1.25rem;
        }
        
        .tool-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .control-item label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .slider-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .slider-group input[type="range"] {
            width: 80px;
            height: 6px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .color-picker {
            width: 44px;
            height: 32px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            background: none;
        }
        
        .color-presets {
            display: flex;
            gap: 0.25rem;
        }
        
        .color-preset {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .color-preset:hover {
            transform: scale(1.1);
            border-color: white;
        }
        
        .action-btn {
            background: rgba(30, 41, 59, 0.6);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .action-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #1d4ed8 100%);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .action-btn.danger {
            background: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
            color: white;
            border-color: var(--accent-red);
        }
        
        /* ÁîªÂ∏ÉÂÆπÂô® */
        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
        }
        
        .canvas-wrapper {
            flex: 1;
            background: #ffffff;
            margin: 1.5rem;
            border-radius: 16px;
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(148, 163, 184, 0.1);
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .canvas-wrapper:hover {
            box-shadow: 
                0 32px 64px -12px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(59, 130, 246, 0.2);
        }
        
        .canvas-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }
        
        /* Áä∂ÊÄÅÊ†è */
        .status-bar {
            background: rgba(15, 23, 42, 0.95);
            color: var(--text-secondary);
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-top: 1px solid var(--border-color);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-bar::before {
            content: "‚óè";
            color: var(--accent-green);
            font-size: 1rem;
        }
        
        /* Âè≥‰æßËæπÊ†è */
        .sidebar-right {
            width: 380px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* AI ËÅäÂ§©ÁïåÈù¢ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            gap: 1rem;
        }
        
        .chat-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .chat-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }
        
        .chat-header i {
            font-size: 1.25rem;
            color: var(--accent-blue);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(148, 163, 184, 0.1);
            min-height: 0;
        }
        
        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 0.875rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            margin-left: 1rem;
            border-left: 3px solid var(--accent-blue);
            color: rgba(203, 213, 225, 0.95);
        }
        
        .message.assistant {
            background: rgba(30, 41, 59, 0.5);
            margin-right: 1rem;
            border-left: 3px solid var(--accent-orange);
            color: rgba(203, 213, 225, 0.9);
        }
        
        .chat-input-area {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 12px;
            padding: 1rem;
            color: white;
            font-size: 0.875rem;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            transition: all 0.3s ease;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .chat-input::placeholder {
            color: rgba(148, 163, 184, 0.6);
        }
        
        .send-btn {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ÂØºËà™Âå∫Âüü */
        .navigation-area {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            background: rgba(15, 23, 42, 0.5);
        }
        
        .nav-links {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .nav-links a {
            background: rgba(30, 41, 59, 0.6);
            color: rgba(203, 213, 225, 0.9);
            text-decoration: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-links a:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }
        
        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.4);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.6);
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1200px) {
            .sidebar-right {
                width: 320px;
            }
            
            .canvas-toolbar {
                padding: 0.75rem;
                gap: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .canvas-layout {
                flex-direction: column;
            }
            
            .sidebar-right {
                width: 100%;
                height: 250px;
            }
            
            .canvas-toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .tool-section {
                align-items: center;
            }
            
            .canvas-wrapper {
                margin: 1rem;
            }
        }
        
        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .shapes-section {
            display: none;
        }
        
        .shapes-section.active {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="canvas-layout">
        <!-- ‰∏ªÁîªÂ∏ÉÂå∫Âüü -->
        <div class="main-canvas-area">
            <!-- Áé∞‰ª£ÂåñÂ∑•ÂÖ∑Ê†è -->
            <div class="canvas-toolbar">
                <!-- ÁªòÂõæÊ®°Âºè -->
                <div class="tool-section">
                    <div class="tool-label">ÁªòÂõæÊ®°Âºè</div>
                    <div class="mode-selector">
                        <button class="mode-btn active" onclick="switchDrawMode('draw')" data-mode="draw" title="Ëá™Áî±ÁªòÂà∂">
                            <i class="fas fa-pen"></i>
                            <span>ÁªòÂà∂</span>
                        </button>
                        <button class="mode-btn" onclick="switchDrawMode('shapes')" data-mode="shapes" title="ÂΩ¢Áä∂Â∑•ÂÖ∑">
                            <i class="fas fa-shapes"></i>
                            <span>ÂΩ¢Áä∂</span>
                        </button>
                        <button class="mode-btn" onclick="switchDrawMode('text')" data-mode="text" title="ÊñáÊú¨Â∑•ÂÖ∑">
                            <i class="fas fa-font"></i>
                            <span>ÊñáÊú¨</span>
                        </button>
                        <button class="mode-btn" onclick="switchDrawMode('select')" data-mode="select" title="ÈÄâÊã©Â∑•ÂÖ∑">
                            <i class="fas fa-mouse-pointer"></i>
                            <span>ÈÄâÊã©</span>
                        </button>
                    </div>
                </div>
                
                <!-- ÂΩ¢Áä∂Â∑•ÂÖ∑ -->
                <div class="tool-section shapes-section" id="shapeTools">
                    <div class="tool-label">ÂΩ¢Áä∂</div>
                    <div class="tool-controls">
                        <button class="action-btn" onclick="addShape('rect')" title="Áü©ÂΩ¢">
                            <i class="far fa-square"></i>
                        </button>
                        <button class="action-btn" onclick="addShape('circle')" title="ÂúÜÂΩ¢">
                            <i class="far fa-circle"></i>
                        </button>
                        <button class="action-btn" onclick="addShape('triangle')" title="‰∏âËßíÂΩ¢">
                            <i class="fas fa-play" style="transform: rotate(90deg);"></i>
                        </button>
                        <button class="action-btn" onclick="addShape('line')" title="Áõ¥Á∫ø">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Ê†∑ÂºèÊéßÂà∂ -->
                <div class="tool-section">
                    <div class="tool-label">Ê†∑Âºè</div>
                    <div class="tool-controls">
                        <div class="control-item">
                            <label>Á≤óÁªÜ</label>
                            <div class="slider-group">
                                <input type="range" id="brushSize" min="1" max="50" value="5" 
                                       onchange="setBrushSize(this.value)" oninput="setBrushSize(this.value)">
                                <span id="brushSizeDisplay">5px</span>
                            </div>
                        </div>
                        <div class="control-item">
                            <label>È¢úËâ≤</label>
                            <div class="color-picker-group">
                                <input type="color" id="colorPicker" value="#000000" class="color-picker" onchange="setColor(this.value)">
                                <div class="color-presets">
                                    <button class="color-preset" style="background: #000000" onclick="setColorPreset('#000000')"></button>
                                    <button class="color-preset" style="background: #ff0000" onclick="setColorPreset('#ff0000')"></button>
                                    <button class="color-preset" style="background: #00ff00" onclick="setColorPreset('#00ff00')"></button>
                                    <button class="color-preset" style="background: #0000ff" onclick="setColorPreset('#0000ff')"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Êñá‰ª∂Êìç‰Ωú -->
                <div class="tool-section">
                    <div class="tool-label">Êñá‰ª∂</div>
                    <div class="tool-controls">
                        <button class="action-btn primary" onclick="newCanvas()" title="Êñ∞Âª∫">
                            <i class="fas fa-file"></i>
                            <span>Êñ∞Âª∫</span>
                        </button>
                        <button class="action-btn" onclick="saveCanvas()" title="‰øùÂ≠ò">
                            <i class="fas fa-save"></i>
                            <span>‰øùÂ≠ò</span>
                        </button>
                        <button class="action-btn" onclick="loadCanvas()" title="Âä†ËΩΩ">
                            <i class="fas fa-folder-open"></i>
                            <span>Âä†ËΩΩ</span>
                        </button>
                    </div>
                </div>
                
                <!-- ÂØºÂá∫ -->
                <div class="tool-section">
                    <div class="tool-label">ÂØºÂá∫</div>
                    <div class="tool-controls">
                        <button class="action-btn" onclick="exportCanvas('png')" title="PNG">
                            <i class="fas fa-image"></i>
                            <span>PNG</span>
                        </button>
                        <button class="action-btn" onclick="exportCanvas('svg')" title="SVG">
                            <i class="fas fa-vector-square"></i>
                            <span>SVG</span>
                        </button>
                        <button class="action-btn" onclick="exportCanvas('json')" title="JSON">
                            <i class="fas fa-code"></i>
                            <span>JSON</span>
                        </button>
                    </div>
                </div>
                
                <!-- Êìç‰Ωú -->
                <div class="tool-section">
                    <div class="tool-label">Êìç‰Ωú</div>
                    <div class="tool-controls">
                        <button class="action-btn danger" onclick="clearCanvas()" title="Ê∏ÖÁ©∫">
                            <i class="fas fa-trash"></i>
                            <span>Ê∏ÖÁ©∫</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ÁîªÂ∏ÉÂÆπÂô® -->
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <canvas id="fabricCanvas"></canvas>
                </div>
                
                <!-- Áä∂ÊÄÅÊ†è -->
                <div class="status-bar" id="statusBar">
                    ‰∏ì‰∏öÁªòÂõæÂ∑•ÂÖ∑Â∑≤Â∞±Áª™
                </div>
            </div>
        </div>
        
        <!-- Âè≥‰æß AI Âä©Êâã -->
        <div class="sidebar-right">
            <div class="chat-container">
                <!-- ËÅäÂ§©Â§¥ÈÉ® -->
                <div class="chat-header">
                    <i class="fas fa-robot"></i>
                    <h3>AI ÁªòÂõæÂä©Êâã</h3>
                </div>
                
                <!-- Ê∂àÊÅØÂå∫Âüü -->
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        <strong>üëã Ê¨¢Ëøé‰ΩøÁî®‰∏ì‰∏öÁªòÂõæÂ∑•ÂÖ∑ÔºÅ</strong><br><br>
                        ÊàëÊòØÊÇ®ÁöÑ AI ÁªòÂõæÂä©ÊâãÔºåÂèØ‰ª•Â∏ÆÊÇ®Ôºö<br><br>
                        üé® <strong>ÂàõÊÑèËÆæËÆ°</strong> - ÁîüÊàêÂõæÂΩ¢ÂàõÊÑèÂíåÂ∏ÉÂ±ÄÂª∫ËÆÆ<br>
                        üìä <strong>ÂõæË°®Âà∂‰Ωú</strong> - ÂçèÂä©ÂàõÂª∫ÊµÅÁ®ãÂõæ„ÄÅÊû∂ÊûÑÂõæ<br>
                        üñºÔ∏è <strong>ËßÜËßâ‰ºòÂåñ</strong> - Êèê‰æõËâ≤ÂΩ©ÂíåÊéíÁâàÂª∫ËÆÆ<br>
                        üí° <strong>ËÆæËÆ°ÁÅµÊÑü</strong> - ÂàÜ‰∫´ËÆæËÆ°ÊäÄÂ∑ßÂíåÊúÄ‰Ω≥ÂÆûË∑µ<br><br>
                        ËØ∑ÂëäËØâÊàëÊÇ®ÊÉ≥Ë¶ÅÂàõÂª∫‰ªÄ‰πàÔºåÊàë‰ºöÊèê‰æõ‰∏ì‰∏öÁöÑÊåáÂØºÔºÅ
                    </div>
                </div>
                
                <!-- ËæìÂÖ•Âå∫Âüü -->
                <div class="chat-input-area">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="ÊèèËø∞ÊÇ®ÁöÑËÆæËÆ°ÈúÄÊ±ÇÔºå‰æãÂ¶ÇÔºöÂ∏ÆÊàëËÆæËÆ°‰∏Ä‰∏™ÁΩëÁ´ôÊû∂ÊûÑÂõæ..."
                        rows="1"
                        onkeydown="handleChatKeydown(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="send-btn" onclick="sendChatMessage()" id="sendBtn" title="ÂèëÈÄÅÊ∂àÊÅØ">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <!-- ÂØºËà™Âå∫Âüü -->
            <div class="navigation-area">
                <div class="nav-links">
                    <a href="/"><i class="fas fa-home"></i> È¶ñÈ°µ</a>
                    <a href="/chat"><i class="fas fa-comments"></i> ËÅäÂ§©</a>
                    <a href="/editor"><i class="fas fa-edit"></i> ÁºñËæëÂô®</a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentDrawMode = 'draw';
        let fabricCanvas = null;
        let chatMessages = [];
        let isLoading = false;
        let currentColor = '#000000';
        let currentBrushSize = 5;
        
        // È°µÈù¢ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üé® AI Gen Studio Canvas Áé∞‰ª£ÁâàÂêØÂä®‰∏≠...');
            
            try {
                // Âä†ËΩΩ Fabric.js
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js');
                console.log('‚úÖ Fabric.js Âä†ËΩΩÂÆåÊàê');
                
                // ÂàùÂßãÂåñÁîªÂ∏É
                initializeCanvas();
                updateStatus('‰∏ì‰∏öÁªòÂõæÂ∑•ÂÖ∑Â∑≤Â∞±Áª™');
                
            } catch (error) {
                console.error('‚ùå ÂàùÂßãÂåñÂ§±Ë¥•:', error);
                updateStatus('ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        });
        
        // Âä®ÊÄÅÂä†ËΩΩËÑöÊú¨
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // ÂàùÂßãÂåñÁîªÂ∏É
        function initializeCanvas() {
            const container = document.querySelector('.canvas-wrapper');
            const canvas = document.getElementById('fabricCanvas');
            
            if (!container || !canvas) {
                console.error('ÁîªÂ∏ÉÂÆπÂô®Êú™ÊâæÂà∞');
                return;
            }
            
            const width = container.clientWidth || 1200;
            const height = container.clientHeight || 800;
            
            fabricCanvas = new fabric.Canvas('fabricCanvas', {
                width: width,
                height: height,
                backgroundColor: 'white',
                selection: true,
                preserveObjectStacking: true
            });
            
            // ËÆæÁΩÆÈªòËÆ§ÁªòÂà∂Ê®°Âºè
            fabricCanvas.isDrawingMode = true;
            fabricCanvas.freeDrawingBrush.width = currentBrushSize;
            fabricCanvas.freeDrawingBrush.color = currentColor;
            
            // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨
            setupCanvasEvents();
            
            console.log('üé® ÁîªÂ∏ÉÂàùÂßãÂåñÂÆåÊàê');
        }
        
        // ËÆæÁΩÆÁîªÂ∏É‰∫ã‰ª∂
        function setupCanvasEvents() {
            if (!fabricCanvas) return;
            
            // ÁªòÂà∂ÂÆåÊàêËá™Âä®‰øùÂ≠ò
            fabricCanvas.on('path:created', function() {
                saveCanvasState();
            });
            
            // ÂØπË±°‰øÆÊîπËá™Âä®‰øùÂ≠ò
            fabricCanvas.on('object:modified', function() {
                saveCanvasState();
            });
            
            // ÈÄâÊã©‰∫ã‰ª∂
            fabricCanvas.on('selection:created', function(e) {
                updateStatus(\`Â∑≤ÈÄâÊã© \${e.selected.length} ‰∏™ÂØπË±°\`);
            });
            
            fabricCanvas.on('selection:cleared', function() {
                updateStatus('ÂèñÊ∂àÈÄâÊã©');
            });
            
            // ÂèåÂáªÊ∑ªÂä†ÊñáÊú¨
            fabricCanvas.on('mouse:dblclick', function(options) {
                if (currentDrawMode === 'text') {
                    const pointer = fabricCanvas.getPointer(options.e);
                    addText(pointer.x, pointer.y);
                }
            });
        }
        
        // ÂàáÊç¢ÁªòÂõæÊ®°Âºè
        function switchDrawMode(mode) {
            if (!fabricCanvas) return;
            
            currentDrawMode = mode;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(\`[data-mode="\${mode}"]\`).classList.add('active');
            
            // ÂàáÊç¢Â∑•ÂÖ∑Ê†èÊòæÁ§∫
            const shapeTools = document.getElementById('shapeTools');
            
            switch(mode) {
                case 'draw':
                    fabricCanvas.isDrawingMode = true;
                    fabricCanvas.selection = false;
                    shapeTools.classList.remove('active');
                    updateStatus('Ëá™Áî±ÁªòÂà∂Ê®°Âºè - Âú®ÁîªÂ∏É‰∏äÁªòÂà∂');
                    break;
                    
                case 'shapes':
                    fabricCanvas.isDrawingMode = false;
                    fabricCanvas.selection = true;
                    shapeTools.classList.add('active');
                    updateStatus('ÂΩ¢Áä∂Â∑•ÂÖ∑Ê®°Âºè - ÁÇπÂáªÊåâÈíÆÊ∑ªÂä†ÂΩ¢Áä∂');
                    break;
                    
                case 'text':
                    fabricCanvas.isDrawingMode = false;
                    fabricCanvas.selection = true;
                    shapeTools.classList.remove('active');
                    updateStatus('ÊñáÊú¨Ê®°Âºè - ÂèåÂáªÁîªÂ∏ÉÊ∑ªÂä†ÊñáÂ≠ó');
                    break;
                    
                case 'select':
                    fabricCanvas.isDrawingMode = false;
                    fabricCanvas.selection = true;
                    shapeTools.classList.remove('active');
                    updateStatus('ÈÄâÊã©Ê®°Âºè - ÁÇπÂáªÈÄâÊã©ÂíåÁºñËæëÂØπË±°');
                    break;
            }
        }
        
        // Ê∑ªÂä†ÂΩ¢Áä∂
        function addShape(type) {
            if (!fabricCanvas) return;
            
            const centerX = fabricCanvas.width / 2;
            const centerY = fabricCanvas.height / 2;
            let shape;
            
            switch(type) {
                case 'rect':
                    shape = new fabric.Rect({
                        left: centerX - 50,
                        top: centerY - 30,
                        width: 100,
                        height: 60,
                        fill: 'transparent',
                        stroke: currentColor,
                        strokeWidth: currentBrushSize
                    });
                    break;
                    
                case 'circle':
                    shape = new fabric.Circle({
                        left: centerX - 40,
                        top: centerY - 40,
                        radius: 40,
                        fill: 'transparent',
                        stroke: currentColor,
                        strokeWidth: currentBrushSize
                    });
                    break;
                    
                case 'triangle':
                    shape = new fabric.Triangle({
                        left: centerX - 40,
                        top: centerY - 35,
                        width: 80,
                        height: 70,
                        fill: 'transparent',
                        stroke: currentColor,
                        strokeWidth: currentBrushSize
                    });
                    break;
                    
                case 'line':
                    shape = new fabric.Line([centerX - 50, centerY, centerX + 50, centerY], {
                        stroke: currentColor,
                        strokeWidth: currentBrushSize
                    });
                    break;
            }
            
            if (shape) {
                fabricCanvas.add(shape);
                fabricCanvas.setActiveObject(shape);
                fabricCanvas.renderAll();
                updateStatus(\`Ê∑ªÂä†‰∫Ü\${type}ÂΩ¢Áä∂\`);
            }
        }
        
        // Ê∑ªÂä†ÊñáÊú¨
        function addText(x, y) {
            if (!fabricCanvas) return;
            
            const text = new fabric.IText('ÁÇπÂáªÁºñËæëÊñáÊú¨', {
                left: x - 50,
                top: y - 10,
                fontFamily: 'Arial, sans-serif',
                fontSize: 20,
                fill: currentColor,
                editable: true
            });
            
            fabricCanvas.add(text);
            fabricCanvas.setActiveObject(text);
            text.enterEditing();
            fabricCanvas.renderAll();
            updateStatus('ÊñáÊú¨Â∑≤Ê∑ªÂä†');
        }
        
        // ËÆæÁΩÆÁîªÁ¨îÂ§ßÂ∞è
        function setBrushSize(size) {
            currentBrushSize = parseInt(size);
            document.getElementById('brushSizeDisplay').textContent = size + 'px';
            
            if (fabricCanvas) {
                fabricCanvas.freeDrawingBrush.width = currentBrushSize;
                
                // Êõ¥Êñ∞ÈÄâ‰∏≠ÂØπË±°
                const activeObject = fabricCanvas.getActiveObject();
                if (activeObject && activeObject.stroke) {
                    activeObject.set('strokeWidth', currentBrushSize);
                    fabricCanvas.renderAll();
                }
            }
        }
        
        // ËÆæÁΩÆÈ¢úËâ≤
        function setColor(color) {
            currentColor = color;
            
            if (fabricCanvas) {
                fabricCanvas.freeDrawingBrush.color = currentColor;
                
                // Êõ¥Êñ∞ÈÄâ‰∏≠ÂØπË±°
                const activeObject = fabricCanvas.getActiveObject();
                if (activeObject) {
                    if (activeObject.stroke) {
                        activeObject.set('stroke', currentColor);
                    } else {
                        activeObject.set('fill', currentColor);
                    }
                    fabricCanvas.renderAll();
                }
            }
        }
        
        // È¢ÑËÆæÈ¢úËâ≤
        function setColorPreset(color) {
            document.getElementById('colorPicker').value = color;
            setColor(color);
        }
        
        // Êñ∞Âª∫ÁîªÂ∏É
        function newCanvas() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊñ∞Âª∫ÁîªÂ∏ÉÂêóÔºüÂΩìÂâçÂÜÖÂÆπÂ∞Ü‰∏¢Â§±„ÄÇ')) return;
            
            if (fabricCanvas) {
                fabricCanvas.clear();
                fabricCanvas.backgroundColor = 'white';
                fabricCanvas.renderAll();
                updateStatus('ÁîªÂ∏ÉÂ∑≤Ê∏ÖÁ©∫');
            }
        }
        
        // Ê∏ÖÁ©∫ÁîªÂ∏É
        function clearCanvas() {
            newCanvas();
        }
        
        // ‰øùÂ≠òÁîªÂ∏É
        function saveCanvas() {
            if (fabricCanvas) {
                const data = fabricCanvas.toJSON();
                localStorage.setItem('aigen-studio-canvas-save', JSON.stringify(data));
                updateStatus('ÁîªÂ∏ÉÂ∑≤‰øùÂ≠ò');
            }
        }
        
        // Âä†ËΩΩÁîªÂ∏É
        function loadCanvas() {
            const data = localStorage.getItem('aigen-studio-canvas-save');
            if (!data) {
                updateStatus('Ê≤°ÊúâÊâæÂà∞‰øùÂ≠òÁöÑÁîªÂ∏É');
                return;
            }
            
            if (fabricCanvas) {
                try {
                    fabricCanvas.loadFromJSON(JSON.parse(data), () => {
                        fabricCanvas.renderAll();
                        updateStatus('ÁîªÂ∏ÉÂ∑≤Âä†ËΩΩ');
                    });
                } catch (error) {
                    updateStatus('Âä†ËΩΩÂ§±Ë¥•: ' + error.message);
                }
            }
        }
        
        // ÂØºÂá∫ÁîªÂ∏É
        function exportCanvas(format) {
            if (!fabricCanvas) {
                updateStatus('ÁîªÂ∏ÉÊú™ÂàùÂßãÂåñ');
                return;
            }
            
            try {
                switch (format) {
                    case 'png':
                        const dataURL = fabricCanvas.toDataURL({
                            format: 'png',
                            quality: 1.0,
                            multiplier: 2
                        });
                        downloadDataURL(dataURL, 'aigen-studio-canvas.png');
                        break;
                    case 'svg':
                        const svg = fabricCanvas.toSVG();
                        downloadText(svg, 'aigen-studio-canvas.svg');
                        break;
                    case 'json':
                        downloadJSON(fabricCanvas.toJSON(), 'aigen-studio-canvas.json');
                        break;
                }
                updateStatus(\`Â∑≤ÂØºÂá∫‰∏∫ \${format.toUpperCase()} Ê†ºÂºè\`);
            } catch (error) {
                updateStatus('ÂØºÂá∫Â§±Ë¥•: ' + error.message);
            }
        }
        
        // Ëá™Âä®‰øùÂ≠òÁä∂ÊÄÅ
        function saveCanvasState() {
            if (fabricCanvas) {
                const state = fabricCanvas.toJSON();
                localStorage.setItem('aigen-studio-canvas-autosave', JSON.stringify(state));
            }
        }
        
        // Êõ¥Êñ∞Áä∂ÊÄÅ
        function updateStatus(message) {
            const statusBar = document.getElementById('statusBar');
            if (statusBar) {
                statusBar.textContent = message;
            }
            console.log('üìù', message);
        }
        
        // AI ËÅäÂ§©ÂäüËÉΩ
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            
            if (!message || isLoading) return;
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            addChatMessage('user', message);
            input.value = '';
            input.style.height = 'auto';
            
            // ËÆæÁΩÆÂä†ËΩΩÁä∂ÊÄÅ
            isLoading = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            sendBtn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: 'system',
                                content: '‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑÁªòÂõæÂä©ÊâãÔºåÊìÖÈïøÂ∏ÆÂä©Áî®Êà∑ÂàõÂª∫ÂêÑÁßçÂõæÂΩ¢„ÄÅÂõæË°®ÂíåËÆæËÆ°„ÄÇËØ∑Êèê‰æõÂÖ∑‰Ωì„ÄÅÂÆûÁî®ÁöÑÁªòÂõæÂª∫ËÆÆ„ÄÇ'
                            },
                            ...chatMessages.slice(-8),
                            { role: 'user', content: message }
                        ]
                    })
                });
                
                const data = await response.json();
                const aiResponse = data.success ? data.data.content : 'Êä±Ê≠âÔºåÊàëÊöÇÊó∂Êó†Ê≥ïÂõûÂ∫î„ÄÇ';
                
                addChatMessage('assistant', aiResponse);
                
            } catch (error) {
                console.error('ËÅäÂ§©ÈîôËØØ:', error);
                addChatMessage('assistant', 'Êä±Ê≠âÔºåËøûÊé•AIÂä©ÊâãÊó∂Âá∫Áé∞ÈîôËØØ„ÄÇ');
            } finally {
                isLoading = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendBtn.disabled = false;
            }
        }
        
        function addChatMessage(role, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = \`message \${role}\`;
            
            // ÁÆÄÂçïÁöÑ Markdown Ê∏≤Êüì
            const formattedContent = content
                .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')
                .replace(/\\*(.*?)\\*/g, '<em>$1</em>')
                .replace(/\`(.*?)\`/g, '<code style="background: rgba(255,255,255,0.1); padding: 0.2rem; border-radius: 3px;">$1</code>')
                .replace(/\\n/g, '<br>');
            
            messageDiv.innerHTML = formattedContent;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // ‰øùÂ≠òÂà∞ËÅäÂ§©ÂéÜÂè≤
            chatMessages.push({ role, content });
            if (chatMessages.length > 20) {
                chatMessages.shift();
            }
        }
        
        // Â∑•ÂÖ∑ÂáΩÊï∞
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadBlob(blob, filename);
        }
        
        function downloadText(text, filename) {
            const blob = new Blob([text], { type: 'text/plain' });
            downloadBlob(blob, filename);
        }
        
        function downloadDataURL(dataURL, filename) {
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = filename;
            link.click();
        }
        
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // ÂìçÂ∫îÂºèÂ§ÑÁêÜ
        window.addEventListener('resize', () => {
            if (fabricCanvas) {
                const container = document.querySelector('.canvas-wrapper');
                if (container) {
                    fabricCanvas.setDimensions({
                        width: container.clientWidth,
                        height: container.clientHeight
                    });
                }
            }
        });
    </script>
</body>
</html>`;
} 