#!/usr/bin/env bash
set -euo pipefail

files=$(git diff --cached --name-only --diff-filter=ACM)
if [ -z "$files" ]; then
  exit 0
fi

blocked_env=$(echo "$files" | grep -E '^\.env(\.local|\.development|\.production)?$' || true)
if [ -n "$blocked_env" ]; then
  echo "Detected staged environment file(s):"
  echo "$blocked_env"
  echo "Remove them from staging."
  exit 1
fi

offenders=""

# Secret detection patterns (avoid matching mere env var names in code)
secret_patterns='(-----BEGIN PRIVATE KEY-----|sk-[A-Za-z0-9]{20,}|eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9)'
# Quoted long tokens (typical API keys) in source files
quoted_long_token='["\''][A-Za-z0-9_\-]{40,}["\'']'

for f in $files; do
  case "$f" in
    node_modules/*|.next/*|*.png|*.jpg|*.jpeg|*.gif|*.svg|*.ico|*.webp|*.mp4|*.mov|*.zip|*.gz|*.tgz|*.wasm|*.ttf|*.otf|*.woff2|*.pdf|*.patch|*.lock|*.tsbuildinfo)
      continue
      ;;
    # Allowlisted content files
    *.md|docs/*|*.example|*.sample|githooks/*)
      continue
      ;;
  esac
  content=$(git show ":$f" || true)
  # Block if any clear secret pattern appears
  if echo "$content" | grep -E -n "$secret_patterns" >/dev/null 2>&1; then
    offenders="$offenders\n$f"
    continue
  fi
  # For source files, flag suspicious quoted long tokens
  case "$f" in
    *.ts|*.tsx|*.js|*.jsx|*.json)
      if echo "$content" | grep -E -n "$quoted_long_token" >/dev/null 2>&1; then
        offenders="$offenders\n$f"
      fi
      ;;
  esac
done

if [ -n "$offenders" ]; then
  echo "Potential secrets detected in staged files:"
  printf "$offenders\n"
  echo "Commit blocked. Remove secrets before committing."
  exit 1
fi

exit 0
